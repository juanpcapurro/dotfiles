#!/bin/sh

# dependecies: dmenu.

LOGDIR=~/timelog
logfile="${LOGDIR}/$(date -I)"

if [ "$1" = "i3blocks" ] ; then
  if [ -e "$logfile" ] ; then
    line="$(tail "$logfile" -n 1)"
    if echo "$line" | grep -- "--$" >/dev/null ; then
      echo "off"
      echo "off"
      exit
    fi
    #long format
    echo "$line"
    # sort format: two words, but 14 characters at most
    echo "$(echo "$line"| cut -d ' ' -f 1,2|head -c 14)"
    last_time=$(echo "$line" | cut -d ' ' -f 1)
    # in minutes
    time_diff=$((($(date +%s) - $(date -d "$last_time"  +%s))/60))
    if [ "$time_diff" -gt 100 ] ; then
      exit 33
    fi
  fi
  exit
fi

if [ ! -d "${LOGDIR}" ] ; then
  mkdir "${LOGDIR}"
fi

files_to_read=""
if [ -e "${logfile}" ] ; then
  files_to_read="${files_to_read} ${logfile}"
fi
yesterdays_logfile="${LOGDIR}/$(date -I -d yesterday)"
if [ -e "${yesterdays_logfile}" ] ; then
  files_to_read="${files_to_read} ${yesterdays_logfile}"
fi

if [ -z "${files_to_read}" ] ; then
  files_to_read=/dev/null
fi

tasks=$(cat ${files_to_read} \
  | cut -d ' ' -f 2- \
  | sort \
  | uniq -c \
  | sort -bnr\
  | cut -b 9- \
  | dmenu -i -p "watchadoin?" -l 20)
if [ -n "${tasks}" ] ; then
  echo "$(date "+%H:%M" ) ${tasks}" >> "${logfile}"
fi

pkill -SIGRTMIN+10 i3blocks
